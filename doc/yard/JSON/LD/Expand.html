<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Module: JSON::LD::Expand
  
    &mdash; Web portal for RDF.rb.
  
</title>

  <link rel="stylesheet" href="../../css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="../../css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '../../';
  framesUrl = "../../frames.html#!JSON/LD/Expand.html";
</script>


  <script type="text/javascript" charset="utf-8" src="../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="../../_index.html">Index (E)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../JSON.html" title="JSON (module)">JSON</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../LD.html" title="JSON::LD (module)">LD</a></span></span>
     &raquo; 
    <span class="title">Expand</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="../../method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="../../file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Module: JSON::LD::Expand
  
  
  
</h1>

<dl class="box">
  
  
    
  
    
      <dt class="r1">Includes:</dt>
      <dd class="r1"><span class='object_link'><a href="Utils.html" title="JSON::LD::Utils (module)">Utils</a></span></dd>
      
    
  
  
    <dt class="r2">Included in:</dt>
    <dd class="r2"><span class='object_link'><a href="API.html" title="JSON::LD::API (class)">API</a></span></dd>
    
  
  
    <dt class="r1 last">Defined in:</dt>
    <dd class="r1 last">vendor/bundler/ruby/2.2.0/bundler/gems/json-ld-b3a436059627/lib/json/ld/expand.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    <p>Expand module, used as part of API</p>


  </div>
</div>
<div class="tags">
  

</div>






  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#expand-instance_method" title="#expand (instance method)">- (Array, Hash) <strong>expand</strong>(input, active_property, context, options = {}) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Expand an Array or Object given an active context and performing local context expansion.</p>
</div></span>
  
</li>

      
    </ul>
  


  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="Utils.html" title="JSON::LD::Utils (module)">Utils</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="Utils.html#add_value-instance_method" title="JSON::LD::Utils#add_value (method)">#add_value</a></span>, <span class='object_link'><a href="Utils.html#as_resource-instance_method" title="JSON::LD::Utils#as_resource (method)">#as_resource</a></span>, <span class='object_link'><a href="Utils.html#blank_node%3F-instance_method" title="JSON::LD::Utils#blank_node? (method)">#blank_node?</a></span>, <span class='object_link'><a href="Utils.html#compare_values-instance_method" title="JSON::LD::Utils#compare_values (method)">#compare_values</a></span>, <span class='object_link'><a href="Utils.html#has_property-instance_method" title="JSON::LD::Utils#has_property (method)">#has_property</a></span>, <span class='object_link'><a href="Utils.html#has_value-instance_method" title="JSON::LD::Utils#has_value (method)">#has_value</a></span>, <span class='object_link'><a href="Utils.html#index%3F-instance_method" title="JSON::LD::Utils#index? (method)">#index?</a></span>, <span class='object_link'><a href="Utils.html#list%3F-instance_method" title="JSON::LD::Utils#list? (method)">#list?</a></span>, <span class='object_link'><a href="Utils.html#node%3F-instance_method" title="JSON::LD::Utils#node? (method)">#node?</a></span>, <span class='object_link'><a href="Utils.html#node_reference%3F-instance_method" title="JSON::LD::Utils#node_reference? (method)">#node_reference?</a></span>, <span class='object_link'><a href="Utils.html#value%3F-instance_method" title="JSON::LD::Utils#value? (method)">#value?</a></span></p>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="expand-instance_method">
  
    - (<tt><span class='object_link'><a href="../../Array.html" title="Array (class)">Array</a></span></tt>, <tt><span class='object_link'><a href="../../Hash.html" title="Hash (class)">Hash</a></span></tt>) <strong>expand</strong>(input, active_property, context, options = {}) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Expand an Array or Object given an active context and performing local context expansion.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>input</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../../Array.html" title="Array (class)">Array</a></span></tt>, <tt><span class='object_link'><a href="../../Hash.html" title="Hash (class)">Hash</a></span></tt>)</span>
      
      
      
    </li>
  
    <li>
      
        <span class='name'>active_property</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../../String.html" title="String (class)">String</a></span></tt>)</span>
      
      
      
    </li>
  
    <li>
      
        <span class='name'>context</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Context.html" title="JSON::LD::Context (class)">Context</a></span></tt>)</span>
      
      
      
    </li>
  
    <li>
      
        <span class='name'>options</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../../Hash.html" title="Hash (class)">Hash</a></span>{<span class='object_link'><a href="../../Symbol.html" title="Symbol (class)">Symbol</a></span> =&gt; <span class='object_link'><a href="../../Object.html" title="Object (class)">Object</a></span>}</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>{}</tt>)</em>
      
      
    </li>
  
</ul>

  
    
    
    
    
    
    
    
    
    <p class="tag_title">Options Hash (<tt>options</tt>):</p>
    <ul class="option">
      
        <li>
          <span class="name">:ordered</span>
          <span class="type">(<tt>Boolean</tt>)</span>
          <span class="default">
            
              &mdash; default:
              <tt>true</tt>
            
          </span>
          
            &mdash; <div class='inline'><p>Ensure output objects have keys ordered properly</p>
</div>
          
        </li>
      
    </ul>
  

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../../Array.html" title="Array (class)">Array</a></span></tt>, <tt><span class='object_link'><a href="../../Hash.html" title="Hash (class)">Hash</a></span></tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'vendor/bundler/ruby/2.2.0/bundler/gems/json-ld-b3a436059627/lib/json/ld/expand.rb', line 17</span>

<span class='kw'>def</span> <span class='id identifier rubyid_expand'>expand</span><span class='lparen'>(</span><span class='id identifier rubyid_input'>input</span><span class='comma'>,</span> <span class='id identifier rubyid_active_property'>active_property</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_options'>options</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='label'>ordered:</span> <span class='kw'>true</span><span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_merge!'>merge!</span><span class='lparen'>(</span><span class='id identifier rubyid_options'>options</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_log_debug'>log_debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>expand</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>input: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_input'>input</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_content'>, active_property: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_active_property'>active_property</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_content'>, context: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_context'>context</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span>
  <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='kw'>case</span> <span class='id identifier rubyid_input'>input</span>
  <span class='kw'>when</span> <span class='const'>Array</span>
    <span class='comment'># If element is an array,
</span>    <span class='id identifier rubyid_log_depth'>log_depth</span> <span class='kw'>do</span>
      <span class='id identifier rubyid_is_list'>is_list</span> <span class='op'>=</span> <span class='id identifier rubyid_context'>context</span><span class='period'>.</span><span class='id identifier rubyid_container'>container</span><span class='lparen'>(</span><span class='id identifier rubyid_active_property'>active_property</span><span class='rparen'>)</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@list</span><span class='tstring_end'>&#39;</span></span>
      <span class='id identifier rubyid_value'>value</span> <span class='op'>=</span> <span class='id identifier rubyid_input'>input</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_v'>v</span><span class='op'>|</span>
        <span class='comment'># Initialize expanded item to the result of using this algorithm recursively, passing active context, active property, and item as element.
</span>        <span class='id identifier rubyid_v'>v</span> <span class='op'>=</span> <span class='id identifier rubyid_expand'>expand</span><span class='lparen'>(</span><span class='id identifier rubyid_v'>v</span><span class='comma'>,</span> <span class='id identifier rubyid_active_property'>active_property</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span><span class='rparen'>)</span>

        <span class='comment'># If the active property is @list or its container mapping is set to @list, the expanded item must not be an array or a list object, otherwise a list of lists error has been detected and processing is aborted.
</span>        <span class='id identifier rubyid_raise'>raise</span> <span class='const'>JsonLdError</span><span class='op'>::</span><span class='const'>ListOfLists</span><span class='comma'>,</span>
              <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>A list may not contain another list</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span>
              <span class='id identifier rubyid_is_list'>is_list</span> <span class='op'>&amp;&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_v'>v</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>||</span> <span class='id identifier rubyid_list?'>list?</span><span class='lparen'>(</span><span class='id identifier rubyid_v'>v</span><span class='rparen'>)</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_v'>v</span>
      <span class='kw'>end</span><span class='period'>.</span><span class='id identifier rubyid_flatten'>flatten</span><span class='period'>.</span><span class='id identifier rubyid_compact'>compact</span>

      <span class='id identifier rubyid_value'>value</span>
    <span class='kw'>end</span>
  <span class='kw'>when</span> <span class='const'>Hash</span>
    <span class='comment'># If element contains the key @context, set active context to the result of the Context Processing algorithm, passing active context and the value of the @context key as local context.
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_input'>input</span><span class='period'>.</span><span class='id identifier rubyid_has_key?'>has_key?</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@context</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
      <span class='id identifier rubyid_context'>context</span> <span class='op'>=</span> <span class='id identifier rubyid_context'>context</span><span class='period'>.</span><span class='id identifier rubyid_parse'>parse</span><span class='lparen'>(</span><span class='id identifier rubyid_input'>input</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@context</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_log_debug'>log_debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>expand</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>context: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_context'>context</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_log_depth'>log_depth</span> <span class='kw'>do</span>
      <span class='id identifier rubyid_output_object'>output_object</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
      <span class='comment'># Then, proceed and process each property and value in element as follows:
</span>      <span class='id identifier rubyid_keys'>keys</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:ordered</span><span class='rbracket'>]</span> <span class='op'>?</span> <span class='id identifier rubyid_input'>input</span><span class='period'>.</span><span class='id identifier rubyid_keys'>keys</span><span class='period'>.</span><span class='id identifier rubyid_kw_sort'>kw_sort</span> <span class='op'>:</span> <span class='id identifier rubyid_input'>input</span><span class='period'>.</span><span class='id identifier rubyid_keys'>keys</span>
      <span class='id identifier rubyid_keys'>keys</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_key'>key</span><span class='op'>|</span>
        <span class='comment'># For each key and value in element, ordered lexicographically by key:
</span>        <span class='id identifier rubyid_value'>value</span> <span class='op'>=</span> <span class='id identifier rubyid_input'>input</span><span class='lbracket'>[</span><span class='id identifier rubyid_key'>key</span><span class='rbracket'>]</span>
        <span class='id identifier rubyid_expanded_property'>expanded_property</span> <span class='op'>=</span> <span class='id identifier rubyid_context'>context</span><span class='period'>.</span><span class='id identifier rubyid_expand_iri'>expand_iri</span><span class='lparen'>(</span><span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='label'>vocab:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>log_depth:</span> <span class='ivar'>@options</span><span class='lbracket'>[</span><span class='symbol'>:log_depth</span><span class='rbracket'>]</span><span class='rparen'>)</span>

        <span class='comment'># If expanded property is null or it neither contains a colon (:) nor it is a keyword, drop key by continuing to the next key.
</span>        <span class='kw'>next</span> <span class='kw'>if</span> <span class='id identifier rubyid_expanded_property'>expanded_property</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>RDF</span><span class='op'>::</span><span class='const'>URI</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_expanded_property'>expanded_property</span><span class='period'>.</span><span class='id identifier rubyid_relative?'>relative?</span>
        <span class='id identifier rubyid_expanded_property'>expanded_property</span> <span class='op'>=</span> <span class='id identifier rubyid_expanded_property'>expanded_property</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='kw'>if</span> <span class='id identifier rubyid_expanded_property'>expanded_property</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>RDF</span><span class='op'>::</span><span class='const'>Resource</span><span class='rparen'>)</span>

        <span class='id identifier rubyid_log_debug'>log_debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>expand property</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ap: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_active_property'>active_property</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_content'>, expanded: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_expanded_property'>expanded_property</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_content'>, value: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span>

        <span class='kw'>if</span> <span class='id identifier rubyid_expanded_property'>expanded_property</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
          <span class='id identifier rubyid_log_debug'>log_debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> =&gt; </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>skip nil property</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span>
          <span class='kw'>next</span>
        <span class='kw'>end</span>

        <span class='kw'>if</span> <span class='const'>KEYWORDS</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_expanded_property'>expanded_property</span><span class='rparen'>)</span>
          <span class='comment'># If active property equals @reverse, an invalid reverse property map error has been detected and processing is aborted.
</span>          <span class='id identifier rubyid_raise'>raise</span> <span class='const'>JsonLdError</span><span class='op'>::</span><span class='const'>InvalidReversePropertyMap</span><span class='comma'>,</span>
                <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>@reverse not appropriate at this point</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_active_property'>active_property</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@reverse</span><span class='tstring_end'>&#39;</span></span>

          <span class='comment'># If result has already an expanded property member, an colliding keywords error has been detected and processing is aborted.
</span>          <span class='id identifier rubyid_raise'>raise</span> <span class='const'>JsonLdError</span><span class='op'>::</span><span class='const'>CollidingKeywords</span><span class='comma'>,</span>
                <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_expanded_property'>expanded_property</span><span class='embexpr_end'>}</span><span class='tstring_content'> already exists in result</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_output_object'>output_object</span><span class='period'>.</span><span class='id identifier rubyid_has_key?'>has_key?</span><span class='lparen'>(</span><span class='id identifier rubyid_expanded_property'>expanded_property</span><span class='rparen'>)</span>

          <span class='id identifier rubyid_expanded_value'>expanded_value</span> <span class='op'>=</span> <span class='kw'>case</span> <span class='id identifier rubyid_expanded_property'>expanded_property</span>
          <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@id</span><span class='tstring_end'>&#39;</span></span>
            <span class='comment'># If expanded property is @id and value is not a string, an invalid @id value error has been detected and processing is aborted
</span>            <span class='id identifier rubyid_raise'>raise</span> <span class='const'>JsonLdError</span><span class='op'>::</span><span class='const'>InvalidIdValue</span><span class='comma'>,</span>
                  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>value of @id must be a string: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>String</span><span class='rparen'>)</span>

            <span class='comment'># Otherwise, set expanded value to the result of using the IRI Expansion algorithm, passing active context, value, and true for document relative.
</span>            <span class='id identifier rubyid_context'>context</span><span class='period'>.</span><span class='id identifier rubyid_expand_iri'>expand_iri</span><span class='lparen'>(</span><span class='id identifier rubyid_value'>value</span><span class='comma'>,</span> <span class='label'>documentRelative:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>log_depth:</span> <span class='ivar'>@options</span><span class='lbracket'>[</span><span class='symbol'>:log_depth</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
          <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@type</span><span class='tstring_end'>&#39;</span></span>
            <span class='comment'># If expanded property is @type and value is neither a string nor an array of strings, an invalid type value error has been detected and processing is aborted. Otherwise, set expanded value to the result of using the IRI Expansion algorithm, passing active context, true for vocab, and true for document relative to expand the value or each of its items.
</span>            <span class='id identifier rubyid_log_debug'>log_debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>@type</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>value: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span>
            <span class='kw'>case</span> <span class='id identifier rubyid_value'>value</span>
            <span class='kw'>when</span> <span class='const'>Array</span>
              <span class='id identifier rubyid_log_depth'>log_depth</span> <span class='kw'>do</span>
                <span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_v'>v</span><span class='op'>|</span>
                  <span class='id identifier rubyid_raise'>raise</span> <span class='const'>JsonLdError</span><span class='op'>::</span><span class='const'>InvalidTypeValue</span><span class='comma'>,</span>
                        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>@type value must be a string or array of strings: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_v'>v</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_v'>v</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>String</span><span class='rparen'>)</span>
                  <span class='id identifier rubyid_context'>context</span><span class='period'>.</span><span class='id identifier rubyid_expand_iri'>expand_iri</span><span class='lparen'>(</span><span class='id identifier rubyid_v'>v</span><span class='comma'>,</span> <span class='label'>vocab:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>documentRelative:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>quiet:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>log_depth:</span> <span class='ivar'>@options</span><span class='lbracket'>[</span><span class='symbol'>:log_depth</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
                <span class='kw'>end</span>
              <span class='kw'>end</span>
            <span class='kw'>when</span> <span class='const'>String</span>
              <span class='id identifier rubyid_context'>context</span><span class='period'>.</span><span class='id identifier rubyid_expand_iri'>expand_iri</span><span class='lparen'>(</span><span class='id identifier rubyid_value'>value</span><span class='comma'>,</span> <span class='label'>vocab:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>documentRelative:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>quiet:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>log_depth:</span> <span class='ivar'>@options</span><span class='lbracket'>[</span><span class='symbol'>:log_depth</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
            <span class='kw'>when</span> <span class='const'>Hash</span>
              <span class='comment'># For framing
</span>              <span class='id identifier rubyid_raise'>raise</span> <span class='const'>JsonLdError</span><span class='op'>::</span><span class='const'>InvalidTypeValue</span><span class='comma'>,</span>
                    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>@type value must be a an empty object for framing: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span>
                    <span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
            <span class='kw'>else</span>
              <span class='id identifier rubyid_raise'>raise</span> <span class='const'>JsonLdError</span><span class='op'>::</span><span class='const'>InvalidTypeValue</span><span class='comma'>,</span>
                    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>@type value must be a string or array of strings: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
            <span class='kw'>end</span>
          <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@graph</span><span class='tstring_end'>&#39;</span></span>
            <span class='comment'># If expanded property is @graph, set expanded value to the result of using this algorithm recursively passing active context, @graph for active property, and value for element.
</span>            <span class='id identifier rubyid_log_depth'>log_depth</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_expand'>expand</span><span class='lparen'>(</span><span class='id identifier rubyid_value'>value</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@graph</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
          <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@value</span><span class='tstring_end'>&#39;</span></span>
            <span class='comment'># If expanded property is @value and value is not a scalar or null, an invalid value object value error has been detected and processing is aborted. Otherwise, set expanded value to value. If expanded value is null, set the @value member of result to null and continue with the next key from element. Null values need to be preserved in this case as the meaning of an @type member depends on the existence of an @value member.
</span>            <span class='id identifier rubyid_raise'>raise</span> <span class='const'>JsonLdError</span><span class='op'>::</span><span class='const'>InvalidValueObjectValue</span><span class='comma'>,</span>
                  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Value of </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_expanded_property'>expanded_property</span><span class='embexpr_end'>}</span><span class='tstring_content'> must be a scalar or null: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Hash</span><span class='rparen'>)</span> <span class='op'>||</span> <span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span>
            <span class='kw'>if</span> <span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
              <span class='id identifier rubyid_output_object'>output_object</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@value</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='kw'>nil</span>
              <span class='kw'>next</span><span class='semicolon'>;</span>
            <span class='kw'>end</span>
            <span class='id identifier rubyid_value'>value</span>
          <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@language</span><span class='tstring_end'>&#39;</span></span>
            <span class='comment'># If expanded property is @language and value is not a string, an invalid language-tagged string error has been detected and processing is aborted. Otherwise, set expanded value to lowercased value.
</span>            <span class='id identifier rubyid_raise'>raise</span> <span class='const'>JsonLdError</span><span class='op'>::</span><span class='const'>InvalidLanguageTaggedString</span><span class='comma'>,</span>
                  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Value of </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_expanded_property'>expanded_property</span><span class='embexpr_end'>}</span><span class='tstring_content'> must be a string: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>String</span><span class='rparen'>)</span>
            <span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_downcase'>downcase</span>
          <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@index</span><span class='tstring_end'>&#39;</span></span>
            <span class='comment'># If expanded property is @index and value is not a string, an invalid @index value error has been detected and processing is aborted. Otherwise, set expanded value to value.
</span>            <span class='id identifier rubyid_raise'>raise</span> <span class='const'>JsonLdError</span><span class='op'>::</span><span class='const'>InvalidIndexValue</span><span class='comma'>,</span>
                  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Value of @index is not a string: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>String</span><span class='rparen'>)</span>
            <span class='id identifier rubyid_value'>value</span>
          <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@list</span><span class='tstring_end'>&#39;</span></span>
            <span class='comment'># If expanded property is @list:
</span>
            <span class='comment'># If active property is null or @graph, continue with the next key from element to remove the free-floating list.
</span>            <span class='kw'>next</span> <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_active_property'>active_property</span> <span class='op'>||</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@graph</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@graph</span><span class='tstring_end'>&#39;</span></span>

            <span class='comment'># Otherwise, initialize expanded value to the result of using this algorithm recursively passing active context, active property, and value for element.
</span>            <span class='id identifier rubyid_value'>value</span> <span class='op'>=</span> <span class='id identifier rubyid_log_depth'>log_depth</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_expand'>expand</span><span class='lparen'>(</span><span class='id identifier rubyid_value'>value</span><span class='comma'>,</span> <span class='id identifier rubyid_active_property'>active_property</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span><span class='rparen'>)</span> <span class='rbrace'>}</span>

            <span class='comment'># Spec FIXME: need to be sure that result is an array
</span>            <span class='id identifier rubyid_value'>value</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_value'>value</span><span class='rbracket'>]</span> <span class='kw'>unless</span> <span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span>

            <span class='comment'># If expanded value is a list object, a list of lists error has been detected and processing is aborted.
</span>            <span class='comment'># Spec FIXME: Also look at each object if result is an array
</span>            <span class='id identifier rubyid_raise'>raise</span> <span class='const'>JsonLdError</span><span class='op'>::</span><span class='const'>ListOfLists</span><span class='comma'>,</span>
                  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>A list may not contain another list</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_any?'>any?</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_v'>v</span><span class='op'>|</span> <span class='id identifier rubyid_list?'>list?</span><span class='lparen'>(</span><span class='id identifier rubyid_v'>v</span><span class='rparen'>)</span><span class='rbrace'>}</span>

            <span class='id identifier rubyid_value'>value</span>
          <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@set</span><span class='tstring_end'>&#39;</span></span>
            <span class='comment'># If expanded property is @set, set expanded value to the result of using this algorithm recursively, passing active context, active property, and value for element.
</span>            <span class='id identifier rubyid_log_depth'>log_depth</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_expand'>expand</span><span class='lparen'>(</span><span class='id identifier rubyid_value'>value</span><span class='comma'>,</span> <span class='id identifier rubyid_active_property'>active_property</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
          <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@reverse</span><span class='tstring_end'>&#39;</span></span>
            <span class='comment'># If expanded property is @reverse and value is not a JSON object, an invalid @reverse value error has been detected and processing is aborted.
</span>            <span class='id identifier rubyid_raise'>raise</span> <span class='const'>JsonLdError</span><span class='op'>::</span><span class='const'>InvalidReverseValue</span><span class='comma'>,</span>
                  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>@reverse value must be an object: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Hash</span><span class='rparen'>)</span>

            <span class='comment'># Otherwise
</span>            <span class='comment'># Initialize expanded value to the result of using this algorithm recursively, passing active context, @reverse as active property, and value as element.
</span>            <span class='id identifier rubyid_value'>value</span> <span class='op'>=</span> <span class='id identifier rubyid_log_depth'>log_depth</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_expand'>expand</span><span class='lparen'>(</span><span class='id identifier rubyid_value'>value</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@reverse</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span><span class='rparen'>)</span> <span class='rbrace'>}</span>

            <span class='comment'># If expanded value contains an @reverse member, i.e., properties that are reversed twice, execute for each of its property and item the following steps:
</span>            <span class='kw'>if</span> <span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_has_key?'>has_key?</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@reverse</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
              <span class='id identifier rubyid_log_debug'>log_debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>@reverse</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>double reverse: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span>
              <span class='id identifier rubyid_value'>value</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@reverse</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_property'>property</span><span class='comma'>,</span> <span class='id identifier rubyid_item'>item</span><span class='op'>|</span>
                <span class='comment'># If result does not have a property member, create one and set its value to an empty array.
</span>                <span class='comment'># Append item to the value of the property member of result.
</span>                <span class='lparen'>(</span><span class='id identifier rubyid_output_object'>output_object</span><span class='lbracket'>[</span><span class='id identifier rubyid_property'>property</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_concat'>concat</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='id identifier rubyid_item'>item</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_flatten'>flatten</span><span class='period'>.</span><span class='id identifier rubyid_compact'>compact</span><span class='rparen'>)</span>
              <span class='kw'>end</span>
            <span class='kw'>end</span>

            <span class='comment'># If expanded value contains members other than @reverse:
</span>            <span class='kw'>unless</span> <span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_keys'>keys</span><span class='period'>.</span><span class='id identifier rubyid_reject'>reject</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_k'>k</span><span class='op'>|</span> <span class='id identifier rubyid_k'>k</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@reverse</span><span class='tstring_end'>&#39;</span></span><span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
              <span class='comment'># If result does not have an @reverse member, create one and set its value to an empty JSON object.
</span>              <span class='id identifier rubyid_reverse_map'>reverse_map</span> <span class='op'>=</span> <span class='id identifier rubyid_output_object'>output_object</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@reverse</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
              <span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_property'>property</span><span class='comma'>,</span> <span class='id identifier rubyid_items'>items</span><span class='op'>|</span>
                <span class='kw'>next</span> <span class='kw'>if</span> <span class='id identifier rubyid_property'>property</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@reverse</span><span class='tstring_end'>&#39;</span></span>
                <span class='id identifier rubyid_items'>items</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_item'>item</span><span class='op'>|</span>
                  <span class='kw'>if</span> <span class='id identifier rubyid_value?'>value?</span><span class='lparen'>(</span><span class='id identifier rubyid_item'>item</span><span class='rparen'>)</span> <span class='op'>||</span> <span class='id identifier rubyid_list?'>list?</span><span class='lparen'>(</span><span class='id identifier rubyid_item'>item</span><span class='rparen'>)</span>
                    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>JsonLdError</span><span class='op'>::</span><span class='const'>InvalidReversePropertyValue</span><span class='comma'>,</span>
                          <span class='id identifier rubyid_item'>item</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span>
                  <span class='kw'>end</span>
                  <span class='id identifier rubyid_merge_value'>merge_value</span><span class='lparen'>(</span><span class='id identifier rubyid_reverse_map'>reverse_map</span><span class='comma'>,</span> <span class='id identifier rubyid_property'>property</span><span class='comma'>,</span> <span class='id identifier rubyid_item'>item</span><span class='rparen'>)</span>
                <span class='kw'>end</span>
              <span class='kw'>end</span>
            <span class='kw'>end</span>

            <span class='comment'># Continue with the next key from element
</span>            <span class='kw'>next</span>
          <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@explicit</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@default</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@embed</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@explicit</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@omitDefault</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@preserve</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@requireAll</span><span class='tstring_end'>&#39;</span></span>
            <span class='comment'># Framing keywords
</span>            <span class='id identifier rubyid_log_depth'>log_depth</span> <span class='lbrace'>{</span> <span class='lbracket'>[</span><span class='id identifier rubyid_expand'>expand</span><span class='lparen'>(</span><span class='id identifier rubyid_value'>value</span><span class='comma'>,</span> <span class='id identifier rubyid_expanded_property'>expanded_property</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span><span class='rparen'>)</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_flatten'>flatten</span> <span class='rbrace'>}</span>
          <span class='kw'>else</span>
            <span class='comment'># Skip unknown keyword
</span>            <span class='kw'>next</span>
          <span class='kw'>end</span>

          <span class='comment'># Unless expanded value is null, set the expanded property member of result to expanded value.
</span>          <span class='id identifier rubyid_log_debug'>log_debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>expand </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_expanded_property'>expanded_property</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_expanded_value'>expanded_value</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='rbrace'>}</span>
          <span class='id identifier rubyid_output_object'>output_object</span><span class='lbracket'>[</span><span class='id identifier rubyid_expanded_property'>expanded_property</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_expanded_value'>expanded_value</span> <span class='kw'>unless</span> <span class='id identifier rubyid_expanded_value'>expanded_value</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
          <span class='kw'>next</span>
        <span class='kw'>end</span>

        <span class='id identifier rubyid_expanded_value'>expanded_value</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_context'>context</span><span class='period'>.</span><span class='id identifier rubyid_container'>container</span><span class='lparen'>(</span><span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@language</span><span class='tstring_end'>&#39;</span></span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Hash</span><span class='rparen'>)</span>
          <span class='comment'># Otherwise, if key&#39;s container mapping in active context is @language and value is a JSON object then value is expanded from a language map as follows:
</span>          
          <span class='comment'># Set multilingual array to an empty array.
</span>          <span class='id identifier rubyid_ary'>ary</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>

          <span class='comment'># For each key-value pair language-language value in value, ordered lexicographically by language
</span>          <span class='id identifier rubyid_keys'>keys</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:ordered</span><span class='rbracket'>]</span> <span class='op'>?</span> <span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_keys'>keys</span><span class='period'>.</span><span class='id identifier rubyid_sort'>sort</span> <span class='op'>:</span> <span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_keys'>keys</span>
          <span class='id identifier rubyid_keys'>keys</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_k'>k</span><span class='op'>|</span>
            <span class='lbracket'>[</span><span class='id identifier rubyid_value'>value</span><span class='lbracket'>[</span><span class='id identifier rubyid_k'>k</span><span class='rbracket'>]</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_flatten'>flatten</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_item'>item</span><span class='op'>|</span>
              <span class='comment'># item must be a string, otherwise an invalid language map value error has been detected and processing is aborted.
</span>              <span class='id identifier rubyid_raise'>raise</span> <span class='const'>JsonLdError</span><span class='op'>::</span><span class='const'>InvalidLanguageMapValue</span><span class='comma'>,</span>
                    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Expected </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_item'>item</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_content'> to be a string</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_item'>item</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>String</span><span class='rparen'>)</span>

              <span class='comment'># Append a JSON object to expanded value that consists of two key-value pairs: (@value-item) and (@language-lowercased language).
</span>              <span class='id identifier rubyid_ary'>ary</span> <span class='op'>&lt;&lt;</span> <span class='lbrace'>{</span>
                <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@value</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_item'>item</span><span class='comma'>,</span>
                <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@language</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_k'>k</span><span class='period'>.</span><span class='id identifier rubyid_downcase'>downcase</span>
              <span class='rbrace'>}</span>
            <span class='kw'>end</span>
          <span class='kw'>end</span>

          <span class='id identifier rubyid_ary'>ary</span>
        <span class='kw'>elsif</span> <span class='id identifier rubyid_context'>context</span><span class='period'>.</span><span class='id identifier rubyid_container'>container</span><span class='lparen'>(</span><span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@index</span><span class='tstring_end'>&#39;</span></span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Hash</span><span class='rparen'>)</span>
          <span class='comment'># Otherwise, if key&#39;s container mapping in active context is @index and value is a JSON object then value is expanded from an index map as follows:
</span>          
          <span class='comment'># Set ary to an empty array.
</span>          <span class='id identifier rubyid_ary'>ary</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>

          <span class='comment'># For each key-value in the object:
</span>          <span class='id identifier rubyid_keys'>keys</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:ordered</span><span class='rbracket'>]</span> <span class='op'>?</span> <span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_keys'>keys</span><span class='period'>.</span><span class='id identifier rubyid_sort'>sort</span> <span class='op'>:</span> <span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_keys'>keys</span>
          <span class='id identifier rubyid_keys'>keys</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_k'>k</span><span class='op'>|</span>
            <span class='comment'># Initialize index value to the result of using this algorithm recursively, passing active context, key as active property, and index value as element.
</span>            <span class='id identifier rubyid_index_value'>index_value</span> <span class='op'>=</span> <span class='id identifier rubyid_log_depth'>log_depth</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_expand'>expand</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='id identifier rubyid_value'>value</span><span class='lbracket'>[</span><span class='id identifier rubyid_k'>k</span><span class='rbracket'>]</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_flatten'>flatten</span><span class='comma'>,</span> <span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
            <span class='id identifier rubyid_index_value'>index_value</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_item'>item</span><span class='op'>|</span>
              <span class='id identifier rubyid_item'>item</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@index</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='id identifier rubyid_k'>k</span>
              <span class='id identifier rubyid_ary'>ary</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_item'>item</span>
            <span class='kw'>end</span>
          <span class='kw'>end</span>
          <span class='id identifier rubyid_ary'>ary</span>
        <span class='kw'>else</span>
          <span class='comment'># Otherwise, initialize expanded value to the result of using this algorithm recursively, passing active context, key for active property, and value for element.
</span>          <span class='id identifier rubyid_log_depth'>log_depth</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_expand'>expand</span><span class='lparen'>(</span><span class='id identifier rubyid_value'>value</span><span class='comma'>,</span> <span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='id identifier rubyid_context'>context</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
        <span class='kw'>end</span>

        <span class='comment'># If expanded value is null, ignore key by continuing to the next key from element.
</span>        <span class='kw'>if</span> <span class='id identifier rubyid_expanded_value'>expanded_value</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
          <span class='id identifier rubyid_log_debug'>log_debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> =&gt; skip nil value</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
          <span class='kw'>next</span>
        <span class='kw'>end</span>
        <span class='id identifier rubyid_log_debug'>log_debug</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> =&gt; </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_expanded_value'>expanded_value</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span>

        <span class='comment'># If the container mapping associated to key in active context is @list and expanded value is not already a list object, convert expanded value to a list object by first setting it to an array containing only expanded value if it is not already an array, and then by setting it to a JSON object containing the key-value pair @list-expanded value.
</span>        <span class='kw'>if</span> <span class='id identifier rubyid_context'>context</span><span class='period'>.</span><span class='id identifier rubyid_container'>container</span><span class='lparen'>(</span><span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@list</span><span class='tstring_end'>&#39;</span></span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_list?'>list?</span><span class='lparen'>(</span><span class='id identifier rubyid_expanded_value'>expanded_value</span><span class='rparen'>)</span>
          <span class='id identifier rubyid_log_debug'>log_debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> =&gt; </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>convert </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_expanded_value'>expanded_value</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_content'> to list</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span>
          <span class='id identifier rubyid_expanded_value'>expanded_value</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@list</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='id identifier rubyid_expanded_value'>expanded_value</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_flatten'>flatten</span><span class='rbrace'>}</span>
        <span class='kw'>end</span>
        <span class='id identifier rubyid_log_debug'>log_debug</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> =&gt; </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_expanded_value'>expanded_value</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span>

        <span class='comment'># Otherwise, if the term definition associated to key indicates that it is a reverse property
</span>        <span class='comment'># Spec FIXME: this is not an otherwise.
</span>        <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_td'>td</span> <span class='op'>=</span> <span class='id identifier rubyid_context'>context</span><span class='period'>.</span><span class='id identifier rubyid_term_definitions'>term_definitions</span><span class='lbracket'>[</span><span class='id identifier rubyid_key'>key</span><span class='rbracket'>]</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_td'>td</span><span class='period'>.</span><span class='id identifier rubyid_reverse_property'>reverse_property</span>
          <span class='comment'># If result has no @reverse member, create one and initialize its value to an empty JSON object.
</span>          <span class='id identifier rubyid_reverse_map'>reverse_map</span> <span class='op'>=</span> <span class='id identifier rubyid_output_object'>output_object</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@reverse</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
          <span class='lbracket'>[</span><span class='id identifier rubyid_expanded_value'>expanded_value</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_flatten'>flatten</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_item'>item</span><span class='op'>|</span>
            <span class='comment'># If item is a value object or list object, an invalid reverse property value has been detected and processing is aborted.
</span>            <span class='id identifier rubyid_raise'>raise</span> <span class='const'>JsonLdError</span><span class='op'>::</span><span class='const'>InvalidReversePropertyValue</span><span class='comma'>,</span>
                  <span class='id identifier rubyid_item'>item</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span> <span class='kw'>if</span> <span class='id identifier rubyid_value?'>value?</span><span class='lparen'>(</span><span class='id identifier rubyid_item'>item</span><span class='rparen'>)</span> <span class='op'>||</span> <span class='id identifier rubyid_list?'>list?</span><span class='lparen'>(</span><span class='id identifier rubyid_item'>item</span><span class='rparen'>)</span>

            <span class='comment'># If reverse map has no expanded property member, create one and initialize its value to an empty array.
</span>            <span class='comment'># Append item to the value of the expanded property member of reverse map.
</span>            <span class='id identifier rubyid_merge_value'>merge_value</span><span class='lparen'>(</span><span class='id identifier rubyid_reverse_map'>reverse_map</span><span class='comma'>,</span> <span class='id identifier rubyid_expanded_property'>expanded_property</span><span class='comma'>,</span> <span class='id identifier rubyid_item'>item</span><span class='rparen'>)</span>
          <span class='kw'>end</span>
        <span class='kw'>else</span>
          <span class='comment'># Otherwise, if key is not a reverse property:
</span>          <span class='comment'># If result does not have an expanded property member, create one and initialize its value to an empty array.
</span>          <span class='lparen'>(</span><span class='id identifier rubyid_output_object'>output_object</span><span class='lbracket'>[</span><span class='id identifier rubyid_expanded_property'>expanded_property</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_concat'>concat</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='id identifier rubyid_expanded_value'>expanded_value</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_flatten'>flatten</span><span class='rparen'>)</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>

      <span class='id identifier rubyid_log_debug'>log_debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>output object</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span><span class='id identifier rubyid_output_object'>output_object</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='rbrace'>}</span>

      <span class='comment'># If result contains the key @value:
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_value?'>value?</span><span class='lparen'>(</span><span class='id identifier rubyid_output_object'>output_object</span><span class='rparen'>)</span>
        <span class='kw'>unless</span> <span class='lparen'>(</span><span class='id identifier rubyid_output_object'>output_object</span><span class='period'>.</span><span class='id identifier rubyid_keys'>keys</span> <span class='op'>-</span> <span class='qwords_beg'>%w(</span><span class='tstring_content'>@value</span><span class='words_sep'> </span><span class='tstring_content'>@language</span><span class='words_sep'> </span><span class='tstring_content'>@type</span><span class='words_sep'> </span><span class='tstring_content'>@index</span><span class='words_sep'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span> <span class='op'>&amp;&amp;</span>
               <span class='lparen'>(</span><span class='id identifier rubyid_output_object'>output_object</span><span class='period'>.</span><span class='id identifier rubyid_keys'>keys</span> <span class='op'>&amp;</span> <span class='qwords_beg'>%w(</span><span class='tstring_content'>@language</span><span class='words_sep'> </span><span class='tstring_content'>@type</span><span class='words_sep'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&lt;</span> <span class='int'>2</span>
          <span class='comment'># The result must not contain any keys other than @value, @language, @type, and @index. It must not contain both the @language key and the @type key. Otherwise, an invalid value object error has been detected and processing is aborted.
</span>          <span class='id identifier rubyid_raise'>raise</span> <span class='const'>JsonLdError</span><span class='op'>::</span><span class='const'>InvalidValueObject</span><span class='comma'>,</span>
          <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>value object has unknown keys: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_output_object'>output_object</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
        <span class='kw'>end</span>

        <span class='id identifier rubyid_output_object'>output_object</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@language</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_output_object'>output_object</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@language</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
        <span class='id identifier rubyid_output_object'>output_object</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@type</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_output_object'>output_object</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@type</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>

        <span class='comment'># If the value of result&#39;s @value key is null, then set result to null.
</span>        <span class='kw'>return</span> <span class='kw'>nil</span> <span class='kw'>if</span> <span class='id identifier rubyid_output_object'>output_object</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@value</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>

        <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_output_object'>output_object</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@value</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>String</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_output_object'>output_object</span><span class='period'>.</span><span class='id identifier rubyid_has_key?'>has_key?</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@language</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
          <span class='comment'># Otherwise, if the value of result&#39;s @value member is not a string and result contains the key @language, an invalid language-tagged value error has been detected (only strings can be language-tagged) and processing is aborted.
</span>          <span class='id identifier rubyid_raise'>raise</span> <span class='const'>JsonLdError</span><span class='op'>::</span><span class='const'>InvalidLanguageTaggedValue</span><span class='comma'>,</span>
                <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>when @language is used, @value must be a string: </span><span class='embexpr_beg'>#{</span><span class='ivar'>@value</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
        <span class='kw'>elsif</span> <span class='op'>!</span><span class='id identifier rubyid_output_object'>output_object</span><span class='period'>.</span><span class='id identifier rubyid_fetch'>fetch</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@type</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>String</span><span class='rparen'>)</span> <span class='op'>||</span>
              <span class='op'>!</span><span class='id identifier rubyid_context'>context</span><span class='period'>.</span><span class='id identifier rubyid_expand_iri'>expand_iri</span><span class='lparen'>(</span><span class='id identifier rubyid_output_object'>output_object</span><span class='period'>.</span><span class='id identifier rubyid_fetch'>fetch</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@type</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='comma'>,</span> <span class='label'>vocab:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>log_depth:</span> <span class='ivar'>@options</span><span class='lbracket'>[</span><span class='symbol'>:log_depth</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>RDF</span><span class='op'>::</span><span class='const'>URI</span><span class='rparen'>)</span>
          <span class='comment'># Otherwise, if the result has a @type member and its value is not an IRI, an invalid typed value error has been detected and processing is aborted.
</span>          <span class='id identifier rubyid_raise'>raise</span> <span class='const'>JsonLdError</span><span class='op'>::</span><span class='const'>InvalidTypedValue</span><span class='comma'>,</span>
                <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>value of @type must be an IRI: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_output_object'>output_object</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@type</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
        <span class='kw'>end</span>
      <span class='kw'>elsif</span> <span class='op'>!</span><span class='id identifier rubyid_output_object'>output_object</span><span class='period'>.</span><span class='id identifier rubyid_fetch'>fetch</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@type</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span>
        <span class='comment'># Otherwise, if result contains the key @type and its associated value is not an array, set it to an array containing only the associated value.
</span>        <span class='id identifier rubyid_output_object'>output_object</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@type</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_output_object'>output_object</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@type</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rbracket'>]</span>
      <span class='kw'>elsif</span> <span class='id identifier rubyid_output_object'>output_object</span><span class='period'>.</span><span class='id identifier rubyid_keys'>keys</span><span class='period'>.</span><span class='id identifier rubyid_any?'>any?</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_k'>k</span><span class='op'>|</span> <span class='qwords_beg'>%w(</span><span class='tstring_content'>@set</span><span class='words_sep'> </span><span class='tstring_content'>@list</span><span class='words_sep'>)</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_k'>k</span><span class='rparen'>)</span><span class='rbrace'>}</span>
        <span class='comment'># Otherwise, if result contains the key @set or @list:
</span>        <span class='comment'># The result must contain at most one other key and that key must be @index. Otherwise, an invalid set or list object error has been detected and processing is aborted.
</span>        <span class='id identifier rubyid_raise'>raise</span> <span class='const'>JsonLdError</span><span class='op'>::</span><span class='const'>InvalidSetOrListObject</span><span class='comma'>,</span>
              <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>@set or @list may only contain @index: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_output_object'>output_object</span><span class='period'>.</span><span class='id identifier rubyid_keys'>keys</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span>
              <span class='lparen'>(</span><span class='id identifier rubyid_output_object'>output_object</span><span class='period'>.</span><span class='id identifier rubyid_keys'>keys</span> <span class='op'>-</span> <span class='qwords_beg'>%w(</span><span class='tstring_content'>@set</span><span class='words_sep'> </span><span class='tstring_content'>@list</span><span class='words_sep'> </span><span class='tstring_content'>@index</span><span class='words_sep'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>

        <span class='comment'># If result contains the key @set, then set result to the key&#39;s associated value.
</span>        <span class='kw'>return</span> <span class='id identifier rubyid_output_object'>output_object</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@set</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_output_object'>output_object</span><span class='period'>.</span><span class='id identifier rubyid_keys'>keys</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@set</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
      <span class='kw'>end</span>

      <span class='comment'># If result contains only the key @language, set result to null.
</span>      <span class='kw'>return</span> <span class='kw'>nil</span> <span class='kw'>if</span> <span class='id identifier rubyid_output_object'>output_object</span><span class='period'>.</span><span class='id identifier rubyid_keys'>keys</span> <span class='op'>==</span> <span class='qwords_beg'>%w(</span><span class='tstring_content'>@language</span><span class='words_sep'>)</span>

      <span class='comment'># If active property is null or @graph, drop free-floating values as follows:
</span>      <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_active_property'>active_property</span> <span class='op'>||</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@graph</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@graph</span><span class='tstring_end'>&#39;</span></span> <span class='op'>&amp;&amp;</span>
        <span class='lparen'>(</span><span class='id identifier rubyid_output_object'>output_object</span><span class='period'>.</span><span class='id identifier rubyid_keys'>keys</span><span class='period'>.</span><span class='id identifier rubyid_any?'>any?</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_k'>k</span><span class='op'>|</span> <span class='qwords_beg'>%w(</span><span class='tstring_content'>@value</span><span class='words_sep'> </span><span class='tstring_content'>@list</span><span class='words_sep'>)</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_k'>k</span><span class='rparen'>)</span><span class='rbrace'>}</span> <span class='op'>||</span>
         <span class='lparen'>(</span><span class='id identifier rubyid_output_object'>output_object</span><span class='period'>.</span><span class='id identifier rubyid_keys'>keys</span> <span class='op'>-</span> <span class='qwords_beg'>%w(</span><span class='tstring_content'>@id</span><span class='words_sep'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_log_debug'>log_debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> =&gt;</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>empty top-level: </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_output_object'>output_object</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='rbrace'>}</span>
        <span class='kw'>return</span> <span class='kw'>nil</span>
      <span class='kw'>end</span>

      <span class='comment'># Re-order result keys if ordering
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span><span class='symbol'>:ordered</span><span class='rbracket'>]</span>
        <span class='id identifier rubyid_output_object'>output_object</span><span class='period'>.</span><span class='id identifier rubyid_keys'>keys</span><span class='period'>.</span><span class='id identifier rubyid_kw_sort'>kw_sort</span><span class='period'>.</span><span class='id identifier rubyid_inject'>inject</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_map'>map</span><span class='comma'>,</span> <span class='id identifier rubyid_kk'>kk</span><span class='op'>|</span> <span class='id identifier rubyid_map'>map</span><span class='lbracket'>[</span><span class='id identifier rubyid_kk'>kk</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_output_object'>output_object</span><span class='lbracket'>[</span><span class='id identifier rubyid_kk'>kk</span><span class='rbracket'>]</span><span class='semicolon'>;</span> <span class='id identifier rubyid_map'>map</span><span class='rbrace'>}</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_output_object'>output_object</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='comment'># Otherwise, unless the value is a number, expand the value according to the Value Expansion rules, passing active property.
</span>    <span class='kw'>return</span> <span class='kw'>nil</span> <span class='kw'>if</span> <span class='id identifier rubyid_input'>input</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='id identifier rubyid_active_property'>active_property</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='id identifier rubyid_active_property'>active_property</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>@graph</span><span class='tstring_end'>&#39;</span></span>
    <span class='id identifier rubyid_context'>context</span><span class='period'>.</span><span class='id identifier rubyid_expand_value'>expand_value</span><span class='lparen'>(</span><span class='id identifier rubyid_active_property'>active_property</span><span class='comma'>,</span> <span class='id identifier rubyid_input'>input</span><span class='comma'>,</span> <span class='label'>log_depth:</span> <span class='ivar'>@options</span><span class='lbracket'>[</span><span class='symbol'>:log_depth</span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_log_debug'>log_debug</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> =&gt; </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_result'>result</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span>
  <span class='id identifier rubyid_result'>result</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

    <div id="footer">
  Generated on Tue Dec 22 09:33:31 2015 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.7.6 (ruby-2.2.4).
</div>

  </body>
</html>